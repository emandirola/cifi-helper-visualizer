<!DOCTYPE html>
<html lang="en">
<head>
    <style>
        body {
            height: 100vh;
            background: #111;
            margin: 0;
            font-family: 'Segoe UI', Arial, sans-serif;
            transition: filter 0.3s;
        }
        body.drag {
            filter: blur(2px);
        }
        .center {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
        }
        .row {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 5vmin;
            margin: 2.5vmin 0;
        }
        .title {
            color: #fff;
            text-align: center;
            margin-bottom: 2vmin;
            font-size: 3em;
            letter-spacing: 0.05em;
        }
        .title::after {
            content: ' ' attr(data-extra);
        }
        .button {
            width: 20vmin;
            aspect-ratio: 1;
            font-size: 5vmin;
            position: relative;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            border-radius: 50%;
            font-weight: bold;
            text-align: center;
            vertical-align: middle;
            align-content: center;
            transition: background 0.5s, box-shadow 1.5s ease-out;
            box-sizing: border-box;
            box-shadow: 0 2px 12px 0 #0008;
            color: #fff;
            border: 3px solid #222;
            cursor: pointer;
            outline: none;
            user-select: none;
        }
        .button.full {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        }
        .button.recent::before {
            border: 0.15em solid yellow;
            border-radius: 50%;
        }
        .button.play {
            background: linear-gradient(135deg, #ff512f 0%, #dd2476 100%);
        }
        .button::before {
            content: attr(data-install);
            font-size: 2em;
            display: inline-block;
            width: 100%;
            height: 100%;
            align-content: center;
            box-sizing: border-box;
        }
        .button[data-extra]::before {
            content: attr(data-install) ' + ' attr(data-extra);
            font-size: 1em;
            border-width: 0.2em;
        }
        .active-step {
            box-shadow: 0 0 0 3vmin orange, 0 2px 12px 0 #0008;
            z-index: 2;
        }
        .button::after {
            content: attr(data-installed) '/' attr(data-max);
            position: absolute;
            bottom: -1em;
            left: -.5em;
            right: -.5em;
            text-align: center;
            font-weight: bold;
            font-size: 1em;
            border: 0.2em solid #222;
            border-radius: 2em;
            background: #888a;
            color: #fff;
        }
        .ship::after {
            content: attr(ship-name);
            font-weight: bold;
            font-size: 2em;
            text-align: center;
            display: block;
            margin-top: 1em;
        }
        #fileInput, #lastInstalls {
            margin: 1em 0.5em;
            padding: 0.5em;
            border-radius: 0.5em;
            border: 1px solid #444;
            background: #222;
            color: #fff;
        }
        #play {
            margin: 1em;
            padding: 0.7em 2em;
            font-size: 1.2em;
            border-radius: 1em;
            border: none;
            background: linear-gradient(135deg, #ff512f 0%, #dd2476 100%);
            color: #fff;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 2px 8px #0006;
            transition: background 0.3s;
        }
        #play:hover {
            background: linear-gradient(135deg, #dd2476 0%, #ff512f 100%);
        }
        #playForm {
            margin: 5vmin;
        }
    </style>
</head>
<body>
    <div class="center">
        <h1 style="color: white; text-align: center;" class="title">Ship Installations</h1>
        <div class="row">
            <div id="install8" class="button"></div>
            <div id="install4" class="button"></div>
            <div id="install6" class="button"></div>
            <div id="install9" class="button"></div>
        </div>
        <div class="row">
            <div id="install2" class="button"></div>
            <div id="install1" class="button"></div>
            <div id="install3" class="button"></div>
        </div>
        <div class="row">
            <div id="install10" class="button"></div>
            <div id="install7" class="button"></div>
            <div id="install5" class="button"></div>
            <div id="install11" class="button"></div>
        </div>
        <form id="playForm" style="display:inline;">
            <input type="file" id="fileInput" accept=".txt">
            <input type="number" id="lastInstalls" value="20">
            <button type="submit" id="play">Play</button>
        </form>
    </div>
    <script type="module">
        let installs = [];
        let ship = '';
        let animations = [];

        const titleDiv = document.querySelector('.title');
        const buttons = document.querySelectorAll('.button');
        const fileInput = document.getElementById('fileInput');
        const lastInstallsInput = document.getElementById('lastInstalls');
        const playButton = document.getElementById('play');

        const maxs = {
            cradle:     [1250, 125, 125, 100, 100,  50,  75, 500, 250, 150, 200],
            auxesia:    [1250,  75,  75, 100, 100,  75,  75, 125, 150,  50, 150],
            zagreus:    [1250,  50,  50, 100, 100, 100, 100, 150,  50, 125, 100],
            hephaestus: [1250,  25,  25,  75,  75,  25, 100, 200, 425, 425, 425],
            demeter:    [  25,1250, 125, 125, 125,  25,  50,  25, 125, 625, 274],
            koios:      [1250,  25,  25,  25,  25,  50,  50, 300, 150, 200, 750],
            zeus:       [1250,   5,   5,  75, 100,  75, 250, 250, 250, 250, 250]
        };

        function getShipMax() {
            return maxs[ship.toLowerCase()];
        }

        function countInstalls(installsArr) {
            return installsArr.reduce((acc, val) => {
                acc[val - 1]++;
                return acc;
            }, Array(11).fill(0));
        }

        function processInstalls() {
            showInstalls(installs);
            markRecent();
        }

        function updateTitle(showing) {
            const totalInstalls = installs.length;
            titleDiv.dataset.extra = `${ship} (${showing}/${totalInstalls})`;
        }

        function showInstalls(instArr) {
            const max = getShipMax();
            const pointsPerInstall = countInstalls(instArr);
            buttons.forEach(button => {
                const n = parseInt(button.dataset.install);
                button.dataset.max = max[n - 1];
                const installed = pointsPerInstall[n - 1];
                button.dataset.installed = installed;
                button.classList.toggle('full', installed === max[n - 1]);
            });
            updateTitle(instArr.length);
        }

        function markRecent() {
            const lastInstalls = parseInt(lastInstallsInput.value);
            const recentInstalls = installs.slice(-lastInstalls);
            const uniqueInstalls = [...new Set(recentInstalls)];
            buttons.forEach(button => {
                const n = parseInt(button.dataset.install);
                button.classList.toggle('recent', uniqueInstalls.includes(n));
            });
            showInstalls(installs.slice(0, installs.length - lastInstalls));
        }

        async function playAnimation() {
            animations.forEach(animation => animation.cancel());
            animations.length = 0;
            const lastInstalls = parseInt(lastInstallsInput.value);
            const recentInstalls = installs.slice(-lastInstalls);
            const adjacentInstallsCount = recentInstalls.reduce((acc, val) => {
                if (acc.length && acc[acc.length - 1].install === val) {
                    acc[acc.length - 1].count++;
                } else {
                    acc.push({ install: val, count: 1 });
                }
                return acc;
            }, []);
            showInstalls(installs.slice(0, -lastInstalls));
            await document.body.animate({}, { duration: 1000 }).finished;
            let shown = 0;
            let prevButton = null;
            for (const inst of adjacentInstallsCount) {
                const { install, count } = inst;
                shown += count;
                const button = document.getElementById(`install${install}`);
                buttons.forEach(btn => delete btn.dataset.extra);
                button.dataset.extra = count;
                showInstalls(installs.slice(0, shown === recentInstalls.length ? undefined : -lastInstalls + shown));
                if (prevButton) {
                    prevButton.classList.remove('active-step');
                }
                button.classList.add('active-step');
                const animation = button.animate([
                    { backgroundColor: 'yellow', transform: 'scale(1.1)' },
                ], {
                    duration: 375,
                    iterations: 2 * count,
                    direction: 'alternate',
                    easing: 'ease-in-out'
                });
                animations.push(animation);
                await animation.finished;
                prevButton = button;
            }
            if (prevButton) {
                prevButton.classList.remove('active-step');
            }
            buttons.forEach(btn => delete btn.dataset.extra);
            showInstalls(installs);
        }

        function readFile(file) {
            const reader = new FileReader();
            reader.onload = function (e) {
                const content = e.target.result;
                installs = content.split('\n').map(line => parseInt(line.trim())).filter(Boolean);
                processInstalls();
            };
            reader.readAsText(file);
            [ship] = file.name.split('-');
        }

        lastInstallsInput.addEventListener('change', markRecent);

        const playForm = document.getElementById('playForm');
        playForm.addEventListener('submit', function(e) {
            e.preventDefault();
            playAnimation();
        });

        fileInput.addEventListener('change', function (event) {
            animations.forEach(animation => animation.cancel());
            animations.length = 0;
            const file = event.target.files[0];
            if (!file) return;
            readFile(file);
        });

        buttons.forEach(button => {
            button.dataset.install = button.id.replace('install', '');
        });

        document.body.addEventListener('dragover', event => {
            event.preventDefault();
            document.body.classList.add('drag');
        });
        document.body.addEventListener('dragleave', () => {
            document.body.classList.remove('drag');
        });
        document.body.addEventListener('drop', event => {
            document.body.classList.remove('drag');
            event.preventDefault();
            const file = event.dataTransfer.items[0].getAsFile();
            if (file?.name.endsWith('.txt')) {
                readFile(file);
            }
        });
    </script>
</body>
</html>